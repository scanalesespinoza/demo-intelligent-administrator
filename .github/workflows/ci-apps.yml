---
name: CI â€” Build & Test (assistant-api / assistant-ui)

'on':
  pull_request: {}
  push:
    branches: ["main", "develop", "feature/**"]
  workflow_dispatch: {}

env:
  MAVEN_OPTS: -Xmx2g
  JAVA_VERSION: '21'
  CONTAINER_IMAGE_REPOSITORY: quay.io/sergio_canales_e/iadmin

jobs:
  detect-changes:
    name: Detect App Changes
    runs-on: ubuntu-latest
    outputs:
      assistant_api: ${{ steps.filter.outputs.assistant_api }}
      assistant_ui: ${{ steps.filter.outputs.assistant_ui }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            assistant_api:
              - 'apps/assistant-api/**'
              - 'pom.xml'
            assistant_ui:
              - 'apps/assistant-ui/**'

  build-and-test-api:
    name: Build & Test (apps/assistant-api)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.assistant_api == 'true' }}
    defaults:
      run:
        working-directory: apps/assistant-api
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Temurin JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Maven Verify (compile + unit tests)
        run: mvn -B -U -DskipTests=false -Dquarkus.test.profile=ci verify

      - name: Upload surefire/failsafe reports (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports-apps-assistant-api
          path: |
            **/target/surefire-reports/**
            **/target/failsafe-reports/**
          if-no-files-found: ignore

  build-and-test-ui:
    name: Build & Test (apps/assistant-ui)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.assistant_ui == 'true' }}
    defaults:
      run:
        working-directory: apps/assistant-ui
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Temurin JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Maven Verify (compile + unit tests)
        run: mvn -B -U -DskipTests=false -Dquarkus.test.profile=ci verify

      - name: Upload surefire/failsafe reports (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports-apps-assistant-ui
          path: |
            **/target/surefire-reports/**
            **/target/failsafe-reports/**
          if-no-files-found: ignore

  aggregate:
    name: Aggregate Build (root)
    runs-on: ubuntu-latest
    needs:
      - detect-changes
      - build-and-test-api
      - build-and-test-ui
    if: ${{ needs.detect-changes.outputs.assistant_api == 'true' || needs.detect-changes.outputs.assistant_ui == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven
      - name: mvn -B -U -DskipTests verify (root)
        run: mvn -B -U -DskipTests verify

  build-and-push-api:
    name: Build & Publish Image (assistant-api)
    runs-on: ubuntu-latest
    needs:
      - detect-changes
      - build-and-test-api
      - aggregate
    if: ${{ needs.detect-changes.outputs.assistant_api == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Temurin JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Maven package (skip tests)
        working-directory: apps/assistant-api
        run: mvn -B -U -DskipTests package

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Quay
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Build and (optionally) push image
        uses: docker/build-push-action@v5
        with:
          context: apps/assistant-api
          file: apps/assistant-api/src/main/docker/Dockerfile.jvm
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          tags: |
            ${{ env.CONTAINER_IMAGE_REPOSITORY }}:assistant-api-${{ github.sha }}
            ${{ env.CONTAINER_IMAGE_REPOSITORY }}:assistant-api-latest

  build-and-push-ui:
    name: Build & Publish Image (assistant-ui)
    runs-on: ubuntu-latest
    needs:
      - detect-changes
      - build-and-test-ui
      - aggregate
    if: ${{ needs.detect-changes.outputs.assistant_ui == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Temurin JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Maven package (skip tests)
        working-directory: apps/assistant-ui
        run: mvn -B -U -DskipTests package

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Quay
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Build and (optionally) push image
        uses: docker/build-push-action@v5
        with:
          context: apps/assistant-ui
          file: apps/assistant-ui/src/main/docker/Dockerfile.jvm
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          tags: |
            ${{ env.CONTAINER_IMAGE_REPOSITORY }}:assistant-ui-${{ github.sha }}
            ${{ env.CONTAINER_IMAGE_REPOSITORY }}:assistant-ui-latest
